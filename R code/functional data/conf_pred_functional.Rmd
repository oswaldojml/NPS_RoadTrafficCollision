---
title: "Nonparametric Analysis of UK Road Accidents"
subtitle: "functional cp for each police force"
author:
    - "Valeria Iapaolo"
    - "Oswaldo Morales"
    - "Riccardo Morandi"
    - "Abylai Orynbassar"
output: html_notebook
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    #dev = c('pdf'),
    fig.align = 'center',
    #fig.path = 'output/',
    fig.height = 6,
    fig.width = 12
)
```

```{r}
library(tidyverse)
library(conformalInference.fd)
library(roahd)
library(lubridate)
library(mgcv)
library(mgcViz)
```

```{r}
load("~/Documents/Nonparametric Statisics/Project/clean data/full_collisions.RData")
```

```{r}
glimpse(full_collisions)
```

we need to create the dataset in a way that they cotain all of the days and a zero if no crashes happened in that day:

```{r}
all_dates <- unique(full_collisions$date)
all_police_forces <- unique(full_collisions$police_force)

full_combinations <- expand.grid(date = all_dates, police_force = all_police_forces)

crashes_per_day_police <- full_combinations %>%
  left_join(full_collisions %>% group_by(date, police_force) %>% summarize(number_of_crashes = n()),
            by = c("date", "police_force")) %>%
  replace_na(list(number_of_crashes = 0))

glimpse(crashes_per_day_police)
```

```{r}
crashes_per_day_police <- crashes_per_day_police %>% mutate(day_of_year = yday(date),
                                                            day = factor(wday(date)),year = year(date))
```

removing the 29 of february for dimensioality problems in the vectors below

```{r}
crashes_per_day_police <- crashes_per_day_police %>% filter(!(month(date)==2 & day(date)==29))
```

```{r}
train_years <- ceiling(seq(2005,2021,by = 1.5))
cal_years <- seq(2006,2021,3)

df_train <- crashes_per_day_police %>% filter(year %in% train_years) 
df_cal <- crashes_per_day_police %>% filter(year %in% cal_years) 
df_test <- crashes_per_day_police %>% filter(year == 2022)
```

starting with a gam and mixed effects

```{r}
gam_train <- bam(number_of_crashes ~ day + year +
                                  s(day_of_year,k = 53, bs = "cr") + 
                       s(police_force, bs = "re"), 
                data = df_train, family=quasipoisson(), method='REML')
```

```{r}
summary(gam_train)
```

```{r}
b <- getViz(gam_train)
```

```{r}
print(plot(b, allTerms = T), pages = 1)
```

1 is sunday here

```{r}
check(b)
```

this is the best so far in terms of explained deviance, the residuals are not great

we now need to build the predictors and the bands manually

```{r}
res_train <- cbind(df_train,preds = predict(gam_train, df_train, type = "response")) %>%
  arrange(police_force,date) %>% mutate(absdiff = abs(number_of_crashes-preds))

res_cal <- cbind(df_cal,preds = predict(gam_train, df_cal, type = "response")) %>%
  arrange(police_force,date) %>% mutate(absdiff = abs(number_of_crashes-preds))

res_test <- cbind(df_test,preds = predict(gam_train, df_test, type = "response")) %>%
  arrange(police_force,date) %>% mutate(absdiff = abs(number_of_crashes-preds))
```

we now nee to compute the modulation functions and the k

```{r}
n_pol <- length(levels(crashes_per_day_police$police_force))

m = 12
l = 5
alpha = 0.1
kS = matrix(nrow = n_pol,ncol = 365)

x = 1:365
line_integral = function(x, y) {
  dx = diff(x)
  end = length(y)
  my = (y[1:(end - 1)] + y[2:end]) / 2
  sum(dx *my)
} 

ceiling((m+1)*(1-alpha))
```

we use the largest value for gamma
H1 = I1

```{r}
for(i in 1:n_pol){
  ad_cal <- res_cal %>% filter(police_force == levels(police_force)[i]) %>%
  dplyr::select(absdiff)
  a_mat <- matrix(ad_cal$absdiff,byrow = F,nrow = 365)
  ncm = apply(a_mat,1,max)
  den = line_integral(x, ncm)
  s = ncm/den
  ncs <- apply(a_mat/s,1,max)
  ncs_sort = c(sort(ncs))
  k = ncs_sort[ceiling((l + 1)*(1-alpha))]
  kS[i,] = k*s
}
```

testing for some police forces:

```{r}
i <- 50

df_filtered <- res_test %>% filter(police_force == levels(police_force)[i]) %>%
  arrange(day_of_year)

df_plot <- data.frame(n = df_filtered$number_of_crashes,pred = df_filtered$preds, 
                      ymax = df_filtered$preds + kS[i,],
                      ymin = pmax( df_filtered$preds - kS[i,], rep(0, 365)),td = 1:365)

df_plot %>% ggplot() + geom_ribbon(aes(x=td,y = pred,ymin = ymin, ymax = ymax), 
                                   fill = "blue", alpha = 0.25) + 
  geom_line(aes(x=td,y = n),linewidth=1,colour = "black") + 
  geom_line(aes(x=td,y = pred),linewidth=1,colour = "blue") + labs(x = "Day", y = "Number of accients",
                                                     title = levels(df_test$police_force)[i])

```

this are not great

```{r}
i <- 10

df_filtered <- res_test %>% filter(police_force == levels(police_force)[i]) %>%
  arrange(day_of_year)

df_plot <- data.frame(n = df_filtered$number_of_crashes,pred = df_filtered$preds, 
                      ymax = df_filtered$preds + kS[i,],
                      ymin = pmax( df_filtered$preds - kS[i,], rep(0, 365)),td = 1:365)

df_plot %>% ggplot() + geom_ribbon(aes(x=td,y = pred,ymin = ymin, ymax = ymax), 
                                   fill = "blue", alpha = 0.25) + 
  geom_line(aes(x=td,y = n),linewidth=1,colour = "black") + 
  geom_line(aes(x=td,y = pred),linewidth=1,colour = "blue") + labs(x = "Day", y = "Number of accients",
                                                     title = levels(df_test$police_force)[i])

```


```{r}
i <- 30

df_filtered <- res_test %>% filter(police_force == levels(police_force)[i]) %>%
  arrange(day_of_year)

df_plot <- data.frame(n = df_filtered$number_of_crashes,pred = df_filtered$preds, 
                      ymax = df_filtered$preds + kS[i,],
                      ymin = pmax( df_filtered$preds - kS[i,], rep(0, 365)),td = 1:365)

df_plot %>% ggplot() + geom_ribbon(aes(x=td,y = pred,ymin = ymin, ymax = ymax), 
                                   fill = "blue", alpha = 0.25) + 
  geom_line(aes(x=td,y = n),linewidth=1,colour = "black") + 
  geom_line(aes(x=td,y = pred),linewidth=1,colour = "blue") + labs(x = "Day", y = "Number of accients",
                                                     title = levels(df_test$police_force)[i])

```

something is wrong.
I think is the fact that we cannodd do this for mixed models since we don't have 
the exchagnability assumption satisfied

we should fit a model for each police force separately.

doing it for Midlands.

```{r}
i <- 50
df_train_mid <- df_train %>% filter(police_force == levels(police_force)[i])
df_cal_mid <- df_cal %>% filter(police_force == levels(police_force)[i])
df_test_mid <- df_test %>% filter(police_force == levels(police_force)[i])
```

```{r}
gam_train_mid <- bam(number_of_crashes ~ day + year +
                                  s(day_of_year,k = 53, bs = "cr"), 
                data = df_train_mid, family=quasipoisson(), method='REML')
```

```{r}
summary(gam_train_mid)
```

```{r}
b_mid <- getViz(gam_train_mid)
```

```{r}
print(plot(b_mid, allTerms = T), pages = 1)
```

1 is sunday here

```{r}
check(b_mid)
```

the fit is very good.

```{r}
res_train_mid <- cbind(df_train_mid,preds = predict(gam_train_mid, df_train_mid, type = "response")) %>%
  arrange(date) %>% mutate(absdiff = abs(number_of_crashes-preds))

res_cal_mid <- cbind(df_cal_mid,preds = predict(gam_train_mid, df_cal_mid, type = "response")) %>%
  arrange(date) %>% mutate(absdiff = abs(number_of_crashes-preds))
```

we now nee to compute the modulation functions and the k

```{r}
m = 12
l = 5
alpha = 0.1
kS_mid = c()

x = 1:365
line_integral = function(x, y) {
  dx = diff(x)
  end = length(y)
  my = (y[1:(end - 1)] + y[2:end]) / 2
  sum(dx *my)
} 

ad_train <- res_train %>% filter(police_force == levels(police_force)[i]) %>%
dplyr::select(absdiff)
a_mat <- matrix(ad_train$absdiff,byrow = F,nrow = 365)
ncm = apply(a_mat,1,max)
den = line_integral(x, ncm)
s = ncm/den
ad_cal <- res_cal %>% filter(police_force == levels(police_force)[i]) %>%
dplyr::select(absdiff)
a_mat <- matrix(ad_cal$absdiff,byrow = F,nrow = 365)
ncs <- apply(a_mat/s,1,max)
ncs_sort = c(sort(ncs))
k = ncs_sort[ceiling((l + 1)*(1-alpha))]
kS_mid = k*s
```

```{r}
preds_mid <- predict(gam_train_mid, df_test_mid, type = "response")
df_test_res <- cbind(df_test_mid,preds_mid) %>% arrange(day_of_year)
```

```{r}
df_plot <- data.frame(n = df_test_res$number_of_crashes,pred = df_test_res$preds, 
                      ymax = df_test_res$preds + kS[i,],
                      ymin = pmax( df_test_res$preds - kS[i,], rep(0, 365)),td = 1:365)

df_plot %>% ggplot() + geom_ribbon(aes(x=td,y = pred,ymin = ymin, ymax = ymax), 
                                   fill = "blue", alpha = 0.25) + 
  geom_line(aes(x=td,y = n),linewidth=1,colour = "black") + 
  geom_line(aes(x=td,y = pred),linewidth=1,colour = "blue") + labs(x = "Day", y = "Number of accients",
                                                     title = levels(df_test$police_force)[i])

```

this is ok here, not great.

trying for other police forces:

metropolitan police

```{r}
i <- 30
df_train_mid <- crashes_per_day_police %>% filter(year <=2016) %>% 
  filter(police_force == levels(police_force)[i])
df_cal_mid <- crashes_per_day_police %>% filter(year > 2016) %>% filter(year < 2022)%>% 
  filter(police_force == levels(police_force)[i])
df_test_mid <- crashes_per_day_police %>% filter(year == 2022)%>% 
  filter(police_force == levels(police_force)[i])
```

```{r}
gam_train_mid <- bam(number_of_crashes ~ day + year +
                                  s(day_of_year,k = 53, bs = "cr"), 
                data = df_train_mid, family=quasipoisson(), method='REML')
```

```{r}
summary(gam_train_mid)
```

```{r}
b_mid <- getViz(gam_train_mid)
```

```{r}
print(plot(b_mid, allTerms = T), pages = 1)
```

1 is sunday here

```{r}
check(b_mid)
```

```{r}
res_train_mid <- cbind(df_train_mid,preds = predict(gam_train_mid, df_train_mid, type = "response")) %>%
  arrange(date) %>% mutate(absdiff = abs(number_of_crashes-preds))

res_cal_mid <- cbind(df_cal_mid,preds = predict(gam_train_mid, df_cal_mid, type = "response")) %>%
  arrange(date) %>% mutate(absdiff = abs(number_of_crashes-preds))
```

we now nee to compute the modulation functions and the k

```{r}
m = 12
l = 5
alpha = 0.1
kS_mid = c()

x = 1:365
line_integral = function(x, y) {
  dx = diff(x)
  end = length(y)
  my = (y[1:(end - 1)] + y[2:end]) / 2
  sum(dx *my)
} 

ad_train <- res_train %>% filter(police_force == levels(police_force)[i]) %>%
dplyr::select(absdiff)
a_mat <- matrix(ad_train$absdiff,byrow = F,nrow = 365)
ncm = apply(a_mat,1,max)
den = line_integral(x, ncm)
s = ncm/den
ad_cal <- res_cal %>% filter(police_force == levels(police_force)[i]) %>%
dplyr::select(absdiff)
a_mat <- matrix(ad_cal$absdiff,byrow = F,nrow = 365)
ncs <- apply(a_mat/s,1,max)
ncs_sort = c(sort(ncs))
k = ncs_sort[ceiling((l + 1)*(1-alpha))]
kS_mid = k*s
```

```{r}
preds_mid <- predict(gam_train_mid, df_test_mid, type = "response")
df_test_res <- cbind(df_test_mid,preds_mid) %>% arrange(day_of_year)
```

```{r}
df_plot <- data.frame(n = df_test_res$number_of_crashes,pred = df_test_res$preds, 
                      ymax = df_test_res$preds + kS[i,],
                      ymin = pmax( df_test_res$preds - kS[i,], rep(0, 365)),td = 1:365)

df_plot %>% ggplot() + geom_ribbon(aes(x=td,y = pred,ymin = ymin, ymax = ymax), 
                                   fill = "blue", alpha = 0.25) + 
  geom_line(aes(x=td,y = n),linewidth=1,colour = "black") + 
  geom_line(aes(x=td,y = pred),linewidth=1,colour = "blue") + labs(x = "Day", y = "Number of accients",
                                                     title = levels(df_test$police_force)[i])

```

the model seems to capture better the behaviour of the data in eack of the police departments.

check the computatios since done by hand.





